<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="color-scheme" content="light">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <title>Daily Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        :root {
            --bg-primary: #f8f8f7;
            --bg-secondary: #ffffff;
            --text-primary: #0f0f0f;
            --text-secondary: #6b6b6b;
            --border: #e6e6e6;
            --accent: #f97316;
            --shadow: rgba(15, 15, 15, 0.06);
            --press: rgba(0, 0, 0, 0.04);
            --success: #16a34a;
            --danger: #dc2626;
        }

        body[data-mode="dark"] {
            --bg-primary: #0f0f10;
            --bg-secondary: #151517;
            --text-primary: #f4f4f5;
            --text-secondary: #9ca3af;
            --border: #242426;
            --accent: #f97316;
            --shadow: rgba(0, 0, 0, 0.4);
            --press: rgba(255, 255, 255, 0.06);
            --success: #22c55e;
            --danger: #f87171;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: env(safe-area-inset-top);
            background: var(--bg-secondary);
            z-index: 3000;
            pointer-events: none;
        }


        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            overflow-y: hidden;
        }

        body.modal-open {
            overflow: hidden;
            touch-action: none;
        }

        .app-container {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--bg-secondary);
            box-shadow: 0 0 60px var(--shadow);
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
            padding-top: env(safe-area-inset-top);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 20px 24px 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: box-shadow 0.2s ease;
        }

        .header.scrolled {
            box-shadow: 0 12px 24px var(--shadow);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 12px;
        }

        .header h1 span {
            color: var(--text-primary);
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            background: var(--bg-primary);
            padding: 4px;
            border-radius: 12px;
        }

        .view-toggle button {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 36px;
            touch-action: manipulation;
        }

        .view-toggle button.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: 0 1px 3px var(--shadow);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-capture {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            margin-top: 12px;
        }

        .quick-capture input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }

        .quick-capture button {
            border: none;
            background: var(--accent);
            color: #fff;
            padding: 0 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            min-height: 40px;
        }

        .header-actions .search-field {
            position: relative;
            flex: 1 1 160px;
            min-width: 160px;
        }

        .header-actions .search-field input {
            width: 100%;
            padding: 8px 12px 8px 34px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
        }

        .header-actions .search-field svg {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            stroke: var(--text-secondary);
        }

        .chip-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chip-button {
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 32px;
            touch-action: manipulation;
        }

        .chip-button.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* Date Navigation */
        .date-nav {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 8px;
            align-items: center;
            padding: 12px 24px 16px;
            background: var(--bg-secondary);
            transition: box-shadow 0.2s ease;
        }

        .date-nav.scrolled {
            box-shadow: 0 10px 20px var(--shadow);
        }

        .date-nav .nav-buttons {
            display: flex;
            gap: 8px;
        }

        .date-nav button {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .date-nav button:hover {
            background: var(--bg-primary);
        }

        .date-nav .today-button {
            width: auto;
            padding: 0 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .current-date {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        /* Daily View */
        .daily-view {
            padding: 0 24px 24px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .day-layout {
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%;
        }

        .day-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .insight-card {
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .insight-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .insight-value {
            font-size: 15px;
            font-weight: 600;
        }

        .insight-subtle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .day-empty {
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px dashed var(--border);
            background: var(--bg-primary);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .time-scroll {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
            overscroll-behavior: contain;
            scrollbar-width: none;
        }

        .time-scroll::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .time-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .time-slot {
            display: grid;
            grid-template-columns: 64px 1fr;
            gap: 12px;
            align-items: flex-start;
            min-height: 56px;
        }

        .slot-interactive {
            border-radius: 12px;
        }

        .slot-interactive:active {
            background: var(--press);
        }

        .time-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            padding-top: 10px;
        }

        .slot-events {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slot-drop {
            min-height: 48px;
            border-radius: 12px;
            border: 1px dashed transparent;
            padding: 4px;
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        .slot-drop.drag-over {
            border-color: var(--accent);
            background: rgba(249, 115, 22, 0.08);
        }

        .time-block {
            position: absolute;
            left: 64px;
            right: 0;
            border-radius: 12px;
            padding: 10px 12px 12px;
            border-left: 4px solid;
            background: var(--bg-primary);
            box-shadow: 0 6px 16px var(--shadow);
            cursor: grab;
        }

        .time-block.completed {
            opacity: 0.6;
        }

        .time-block:active {
            cursor: grabbing;
        }

        .time-block .block-title {
            font-size: 14px;
            font-weight: 700;
        }

        .time-block .block-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .time-block .resize-handle {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 6px;
            border-radius: 999px;
            background: var(--border);
            cursor: ns-resize;
        }

        .time-block.focus-block {
            background: rgba(15, 23, 42, 0.85);
            color: #fff;
            border-left-color: #0ea5e9;
        }

        .time-block.focus-block .block-meta {
            color: rgba(255, 255, 255, 0.7);
        }

        .time-block.type-event {
            background: rgba(59, 130, 246, 0.12);
        }

        .time-block.type-task {
            background: rgba(16, 185, 129, 0.12);
        }

        .now-line {
            position: absolute;
            left: 64px;
            right: 0;
            height: 2px;
            background: var(--accent);
            border-radius: 999px;
            opacity: 0.8;
            z-index: 5;
        }

        .now-line::before {
            content: '';
            position: absolute;
            left: -6px;
            top: -4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
        }

        .swipe-card {
            touch-action: pan-y;
        }

        .event-card {
            padding: 12px 16px;
            border-radius: 12px;
            border-left: 3px solid;
            background: var(--bg-primary);
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .event-card:hover {
            transform: translateX(2px);
        }

        .event-card.completed {
            opacity: 0.55;
            background: var(--bg-primary);
        }

        .event-card.completed .event-title {
            text-decoration: line-through;
        }

        .event-card.just-completed {
            animation: completion-pop 0.35s ease;
            box-shadow: 0 8px 24px rgba(22, 163, 74, 0.25);
        }

        .event-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .event-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .meta-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .meta-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .priority-high {
            background: rgba(220, 38, 38, 0.15);
            color: var(--danger);
            border-color: rgba(220, 38, 38, 0.3);
        }

        .priority-medium {
            background: rgba(249, 115, 22, 0.18);
            color: var(--accent);
            border-color: rgba(249, 115, 22, 0.3);
        }

        .priority-low {
            background: rgba(34, 197, 94, 0.18);
            color: var(--success);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .card-check {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--success);
            background: var(--bg-secondary);
            opacity: 0;
            transform: scale(0.7);
            transition: all 0.2s ease;
        }

        .event-card.completed .card-check {
            opacity: 1;
            transform: scale(1);
        }

        .day-tasks-panel {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 16px;
            background: var(--bg-secondary);
            overflow-y: auto;
            overscroll-behavior: contain;
            margin-right: 92px;
            scrollbar-width: none;
        }

        .day-tasks-panel::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .panel-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            background: var(--bg-primary);
            border: 1px solid transparent;
            cursor: pointer;
        }

        .task-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .task-title {
            font-size: 14px;
            font-weight: 600;
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .priority-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
        }

        .priority-dot.must {
            background: var(--danger);
        }

        .priority-dot.should {
            background: var(--accent);
        }

        .priority-dot.optional {
            background: var(--success);
        }

        .task-row.completed {
            opacity: 0.55;
            text-decoration: line-through;
        }

        .inbox-panel {
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            background: var(--bg-primary);
            display: grid;
            gap: 8px;
        }

        .inbox-item {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 13px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            cursor: grab;
        }

        .inbox-item:active {
            cursor: grabbing;
        }

        .inbox-item .meta-chip {
            font-size: 10px;
        }

        .review-panel {
            display: grid;
            gap: 12px;
        }

        .review-card {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px 14px;
            background: var(--bg-primary);
        }

        .review-card h3 {
            font-size: 14px;
            margin-bottom: 6px;
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
        }

        /* Week View */
        .week-view,
        .month-view {
            padding: 0 24px 24px;
            display: none;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .week-view::-webkit-scrollbar,
        .month-view::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .week-view.active,
        .month-view.active {
            display: block;
        }

        .week-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .day-column {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
        }

        .day-column.today {
            border-color: var(--accent);
            box-shadow: 0 12px 24px rgba(249, 115, 22, 0.15);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .day-name {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .day-date {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .day-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .homework-item {
            padding: 10px 12px;
            border-radius: 8px;
            border-left: 3px solid;
            background: var(--bg-primary);
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
            position: relative;
        }

        .homework-item:hover {
            transform: translateX(2px);
        }

        .homework-item.completed {
            opacity: 0.55;
            text-decoration: line-through;
        }

        .homework-class {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
        }

        /* All View */
        .month-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .month-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .month-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 8px;
        }

        .month-cell {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            min-height: 140px;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .month-cell.today {
            border-color: var(--accent);
            box-shadow: 0 10px 20px rgba(249, 115, 22, 0.12);
        }

        .month-cell.selected {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .month-day {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .month-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .month-pill {
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 12px;
            border-left: 3px solid;
            background: var(--bg-primary);
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .month-pill:hover {
            transform: translateX(2px);
        }

        .month-empty {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Add Button */
        .add-button {
            position: fixed;
            bottom: calc(24px + env(safe-area-inset-bottom));
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .today-button-fab {
            right: 24px;
            left: auto;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            width: auto;
            padding: 0 16px;
            border-radius: 999px;
            bottom: calc(96px + env(safe-area-inset-bottom));
        }

        .today-button-fab:hover {
            background: var(--bg-primary);
        }

        .add-button:hover {
            transform: scale(1.05);
        }

        .add-button:active {
            transform: scale(0.95);
        }

        .settings-icon-button {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .settings-icon-button:hover {
            background: var(--bg-primary);
        }

        .settings-icon {
            width: 18px;
            height: 18px;
            stroke: var(--text-primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            overscroll-behavior: contain;
        }

        .modal.active {
            display: flex;
            opacity: 1;
        }

        .modal.lock {
            z-index: 2000;
            background: rgba(0, 0, 0, 0.65);
        }

        .lock-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .lock-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .passcode-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0 20px;
        }

        .passcode-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: transparent;
        }

        .passcode-dot.filled {
            background: var(--text-primary);
            border-color: var(--text-primary);
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .keypad button {
            height: 56px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            touch-action: manipulation;
        }

        .keypad .keypad-action {
            background: var(--bg-secondary);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 32px 24px;
            max-width: 380px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            transform: scale(0.9);
            transition: transform 0.2s ease;
            will-change: transform;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            touch-action: pan-y;
        }

        .modal-content::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            letter-spacing: -0.02em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
            max-width: 100%;
            min-width: 0;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-secondary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .form-group input[type="date"] {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
        }

        .toggle-row-labels {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .toggle-row-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .toggle-row-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .form-group .toggle-input {
            position: relative;
            width: 40px;
            height: 20px;
            appearance: none;
            background: var(--border);
            border-radius: 999px;
            outline: none;
            cursor: pointer;
            transition: background 0.2s ease;
            flex-shrink: 0;
            display: inline-block;
        }

        .form-group .toggle-input::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-50%);
        }

        .form-group .toggle-input:checked {
            background: var(--accent);
        }

        .form-group .toggle-input:checked::after {
            transform: translate(16px, -50%);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .color-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--bg-secondary);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }


        .btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: #fee2e2;
            color: var(--danger);
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .recurring-days {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .recurring-presets {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .day-checkbox {
            display: none;
        }

        .day-label {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            touch-action: manipulation;
        }

        .day-checkbox:checked + .day-label {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .empty-state {
            text-align: center;
            padding: 60px 24px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .helper-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .time-picker {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .interval-picker {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .time-picker select {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            font-size: 16px;
        }

        .interval-picker select {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            font-size: 16px;
        }

        .time-picker .time-clear {
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
        }

        .view-toggle button:focus-visible,
        .chip-button:focus-visible,
        .date-nav button:focus-visible,
        .add-button:focus-visible,
        .btn:focus-visible,
        .color-option:focus-visible,
        .day-label:focus-visible,
        .keypad button:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-tap-highlight-color: transparent;
                overscroll-behavior-y: contain;
            }
        }

        @keyframes completion-pop {
            0% { transform: scale(0.98); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
                scroll-behavior: auto !important;
            }
        }

        @media (max-width: 420px) {
            .month-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="header-top">
                <h1><span id="userNameDisplay">Your</span> Planner</h1>
                <button class="settings-icon-button" onclick="openSettingsModal()" aria-label="Settings">
                    <svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.7 1.7 0 0 0 .3 1.9l.1.1a2 2 0 1 1-2.8 2.8l-.1-.1a1.7 1.7 0 0 0-1.9-.3 1.7 1.7 0 0 0-1 1.6V21a2 2 0 1 1-4 0v-.1a1.7 1.7 0 0 0-1-1.6 1.7 1.7 0 0 0-1.9.3l-.1.1a2 2 0 1 1-2.8-2.8l.1-.1a1.7 1.7 0 0 0 .3-1.9 1.7 1.7 0 0 0-1.6-1H3a2 2 0 1 1 0-4h.1a1.7 1.7 0 0 0 1.6-1 1.7 1.7 0 0 0-.3-1.9l-.1-.1a2 2 0 1 1 2.8-2.8l.1.1a1.7 1.7 0 0 0 1.9.3 1.7 1.7 0 0 0 1-1.6V3a2 2 0 1 1 4 0v.1a1.7 1.7 0 0 0 1 1.6 1.7 1.7 0 0 0 1.9-.3l.1-.1a2 2 0 1 1 2.8 2.8l-.1.1a1.7 1.7 0 0 0-.3 1.9 1.7 1.7 0 0 0 1.6 1H21a2 2 0 1 1 0 4h-.1a1.7 1.7 0 0 0-1.5 1z"></path>
                    </svg>
                </button>
            </div>
            <div class="view-toggle">
                <button class="active" onclick="switchView('day', this)">Day</button>
                <button onclick="switchView('week', this)">Week</button>
                <button onclick="switchView('month', this)">Month</button>
            </div>
            <div class="quick-capture">
                <input type="text" id="quickCaptureInput" placeholder="Quick add: “Study physics tomorrow 3-5”" aria-label="Quick capture">
                <button onclick="handleQuickCapture()">Add</button>
            </div>
            <div class="header-actions">
                <div class="search-field">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="11" cy="11" r="7"></circle>
                        <path d="M20 20l-3.5-3.5"></path>
                    </svg>
                    <input type="search" id="searchInput" placeholder="Search items" oninput="updateSearch(this.value)" aria-label="Search items">
                </div>
                <div class="chip-group">
                    <button class="chip-button active" data-filter="all" onclick="setFilter('all', this)">All</button>
                    <button class="chip-button" data-filter="event" onclick="setFilter('event', this)">Events</button>
                    <button class="chip-button" data-filter="task" onclick="setFilter('task', this)">Tasks</button>
                    <button class="chip-button" data-filter="inbox" onclick="setFilter('inbox', this)">Inbox</button>
                    <button class="chip-button" data-filter="block" onclick="setFilter('block', this)">Focus Blocks</button>
                    <button class="chip-button" id="hideCompletedToggle" onclick="toggleHideCompleted(this)">Hide Done</button>
                    <button class="chip-button" id="priorityToggle" onclick="togglePriorityFilter(this)">Must Priority</button>
                    <button class="chip-button" onclick="openReviewModal()">Review</button>
                </div>
            </div>
        </div>

        <div class="date-nav">
            <div class="nav-buttons">
                <button onclick="changeDate(-1)">‹</button>
            </div>
            <div class="current-date" id="currentDate"></div>
            <div class="nav-buttons" style="justify-self: end;">
                <button onclick="changeDate(1)">›</button>
            </div>
        </div>

        <div class="daily-view" id="dailyView"></div>
        <div class="week-view" id="weekView"></div>
        <div class="month-view" id="monthView"></div>

        <button class="add-button today-button-fab" onclick="goToday()">Today</button>
        <button class="add-button" onclick="openAddModal()">+</button>
    </div>

    <div class="modal" id="addModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Item</h2>

            <div class="form-group">
                <label>Type</label>
                <select id="itemCategory" onchange="updateFormFields()">
                    <option value="task">Task</option>
                    <option value="event">Event</option>
                    <option value="block">Focus Block</option>
                </select>
            </div>

            <div class="form-group">
                <label>Label</label>
                <input type="text" id="itemKind" list="eventTypes" placeholder="Optional">
                <datalist id="eventTypes"></datalist>
                <datalist id="taskTypes"></datalist>
                <datalist id="blockTypes"></datalist>
                <div class="helper-text">Create your own type or pick a suggestion.</div>
            </div>

            <div class="form-group" id="titleGroup">
                <label>Title</label>
                <input type="text" id="itemTitle" placeholder="e.g., Read Chapter 3">
            </div>

            <div class="form-group" id="priorityGroup">
                <label>Priority</label>
                <select id="itemPriority">
                    <option value="must">Must</option>
                    <option value="should" selected>Should</option>
                    <option value="optional">Optional</option>
                </select>
            </div>

            <div class="form-group" id="tagGroup">
                <label>Project / Tag</label>
                <input type="text" id="itemTag" placeholder="e.g., School, Work, Personal">
                <div class="helper-text">Use a single tag to group items across views.</div>
            </div>

            <div class="form-group" id="durationGroup">
                <label>Duration (minutes)</label>
                <input type="number" id="itemDuration" min="0" placeholder="e.g., 45">
            </div>

            <div class="form-group" id="statusGroup">
                <label>Status</label>
                <select id="itemStatus" onchange="updateStatusFields()">
                    <option value="inbox">Inbox</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="completed">Completed</option>
                </select>
                <div class="helper-text">Scheduled items show on the calendar.</div>
            </div>

            <div class="form-group" id="locationGroup">
                <label>Location</label>
                <input type="text" id="itemLocation" placeholder="e.g., Campus library">
            </div>

            <div class="form-group" id="repeatToggleGroup">
                <label>Repeats</label>
                <select id="itemRepeats" onchange="updateRepeatVisibility()">
                    <option value="none">Does not repeat</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="custom">Custom interval</option>
                </select>
            </div>

            <div class="form-group" id="repeatIntervalGroup" style="display: none;">
                <label>Every</label>
                <div class="interval-picker">
                    <select id="repeatInterval">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                    <select id="repeatUnit">
                        <option value="day">day(s)</option>
                        <option value="week">week(s)</option>
                        <option value="month">month(s)</option>
                    </select>
                    <div></div>
                </div>
            </div>

            <div class="form-group" id="dateGroup">
                <label id="dateLabel">Date</label>
                <input type="date" id="itemDate">
            </div>

            <div class="form-group" id="timeGroup">
                <label>Start time</label>
                <div class="time-picker" data-field="itemStartTime">
                    <select class="time-hour"></select>
                    <select class="time-minute"></select>
                    <select class="time-ampm"></select>
                    <button class="time-clear" type="button" onclick="clearTimePicker('itemStartTime')">Clear</button>
                </div>
            </div>

            <div class="form-group" id="endTimeGroup">
                <label>End time</label>
                <div class="time-picker" data-field="itemEndTime">
                    <select class="time-hour"></select>
                    <select class="time-minute"></select>
                    <select class="time-ampm"></select>
                    <button class="time-clear" type="button" onclick="clearTimePicker('itemEndTime')">Clear</button>
                </div>
            </div>

            <div class="form-group" id="descriptionGroup">
                <label>Notes</label>
                <textarea id="itemDescription" placeholder="Add details..."></textarea>
            </div>

            <div class="form-group" id="colorGroup">
                <label>Color</label>
                <div class="color-picker" id="colorPicker"></div>
            </div>

            <div class="form-group" id="recurringGroup" style="display: none;">
                <label>Repeat days</label>
                <div class="recurring-presets">
                    <button class="chip-button" type="button" onclick="applyRecurringPreset('weekdays')">Weekdays</button>
                    <button class="chip-button" type="button" onclick="applyRecurringPreset('weekends')">Weekends</button>
                    <button class="chip-button" type="button" onclick="applyRecurringPreset('daily')">Daily</button>
                    <button class="chip-button" type="button" onclick="clearRecurringPreset()">Clear</button>
                </div>
                <div class="recurring-days">
                    <input type="checkbox" id="mon" class="day-checkbox" value="1">
                    <label for="mon" class="day-label">Mon</label>
                    <input type="checkbox" id="tue" class="day-checkbox" value="2">
                    <label for="tue" class="day-label">Tue</label>
                    <input type="checkbox" id="wed" class="day-checkbox" value="3">
                    <label for="wed" class="day-label">Wed</label>
                    <input type="checkbox" id="thu" class="day-checkbox" value="4">
                    <label for="thu" class="day-label">Thu</label>
                    <input type="checkbox" id="fri" class="day-checkbox" value="5">
                    <label for="fri" class="day-label">Fri</label>
                    <input type="checkbox" id="sat" class="day-checkbox" value="6">
                    <label for="sat" class="day-label">Sat</label>
                    <input type="checkbox" id="sun" class="day-checkbox" value="0">
                    <label for="sun" class="day-label">Sun</label>
                </div>
            </div>

            <div class="form-group" id="checklistGroup">
                <label>Checklist (one per line)</label>
                <textarea id="itemChecklist" placeholder="- Outline, - Draft, - Review"></textarea>
            </div>

            <div class="form-group" id="linksGroup">
                <label>Links</label>
                <input type="text" id="itemLinks" placeholder="Paste important URLs separated by commas">
            </div>

            <div class="form-group" id="seriesGroup" style="display: none;">
                <label>Series edits</label>
                <div class="toggle-row">
                    <div class="toggle-row-labels">
                        <div class="toggle-row-title">Apply changes to entire series</div>
                        <div class="toggle-row-subtitle">Turn off to edit only this occurrence.</div>
                    </div>
                    <input type="checkbox" class="toggle-input" id="applySeriesToggle" role="switch" checked>
                </div>
                <button class="btn btn-secondary" type="button" onclick="skipOccurrence()">Skip this occurrence</button>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button class="btn btn-danger" id="deleteButton" style="display:none;" onclick="deleteCurrentItem()">Delete</button>
                <button class="btn btn-primary" id="saveButton" onclick="addOrUpdateItem()">Add</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2>Settings</h2>
            <div class="form-group">
                <label>Your name</label>
                <input type="text" id="userNameInput" placeholder="e.g., Alex">
            </div>
            <div class="form-group">
                <div class="toggle-row">
                    <div class="toggle-row-labels">
                        <div class="toggle-row-title">Dark mode</div>
                        <div class="toggle-row-subtitle">Use a darker appearance.</div>
                    </div>
                    <input type="checkbox" class="toggle-input" id="darkModeToggle" role="switch">
                </div>
            </div>
            <div class="form-group">
                <label>Notifications</label>
                <button class="chip-button" id="notifyButton" onclick="toggleNotifications()">Notifications Off</button>
                <div class="helper-text">Get a 10-minute heads-up for scheduled items.</div>
            </div>
            <div class="form-group">
                <label>Passcode lock</label>
                <select id="passcodeToggle" onchange="updatePasscodeVisibility()">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                </select>
                <div class="helper-text">If enabled, you will be asked to unlock on open.</div>
            </div>
            <div class="form-group" id="passcodeGroup">
                <label>Set passcode</label>
                <input type="password" id="passcodeInput" inputmode="numeric" placeholder="4-8 digits">
                <div class="helper-text">Leave blank to keep current passcode.</div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeSettingsModal()">Close</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="reviewModal">
        <div class="modal-content">
            <h2>Review & Reflection</h2>
            <div class="review-panel" id="reviewPanel"></div>
            <div class="form-group">
                <label>Reflection notes</label>
                <textarea id="reviewNotes" placeholder="What went well? What needs adjustment?"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeReviewModal()">Close</button>
                <button class="btn btn-primary" onclick="saveReviewNotes()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal lock" id="lockModal">
        <div class="modal-content">
            <div class="lock-title">Locked</div>
            <div class="lock-subtitle">Enter your passcode to continue.</div>
            <div class="passcode-dots" id="passcodeDots">
                <div class="passcode-dot"></div>
                <div class="passcode-dot"></div>
                <div class="passcode-dot"></div>
                <div class="passcode-dot"></div>
            </div>
            <div class="keypad" id="passcodeKeypad">
                <button onclick="pressPasscodeKey('1')">1</button>
                <button onclick="pressPasscodeKey('2')">2</button>
                <button onclick="pressPasscodeKey('3')">3</button>
                <button onclick="pressPasscodeKey('4')">4</button>
                <button onclick="pressPasscodeKey('5')">5</button>
                <button onclick="pressPasscodeKey('6')">6</button>
                <button onclick="pressPasscodeKey('7')">7</button>
                <button onclick="pressPasscodeKey('8')">8</button>
                <button onclick="pressPasscodeKey('9')">9</button>
                <button class="keypad-action" onclick="clearPasscodeEntry()">Clear</button>
                <button onclick="pressPasscodeKey('0')">0</button>
                <button class="keypad-action" onclick="backspacePasscode()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let currentView = 'day';
        let editingItem = null;

        const colors = [
            '#ef4444', '#f97316', '#f59e0b', '#84cc16',
            '#10b981', '#06b6d4', '#3b82f6', '#6366f1',
            '#8b5cf6', '#ec4899', '#64748b', '#000000'
        ];

        const defaultEventTypes = ['Meeting', 'Class', 'Appointment', 'Workshop'];
        const defaultTaskTypes = ['Homework', 'Study', 'Email', 'Errand'];
        const defaultBlockTypes = ['Deep Work', 'Focus', 'No Meetings'];

        let items = [];
        let reminderTimers = [];
        let notificationsEnabled = false;
        let userName = 'Your';
        let passcodeEnabled = false;
        let passcodeValue = '';
        let darkModeEnabled = false;
        let nowLineTimer = null;
        let lastAutoScrollHour = null;
        let passcodeEntry = '';
        let scrollShadowTarget = null;
        let scrollShadowHandler = null;
        let daySwipeTarget = null;
        let daySwipeHandlers = null;
        let currentFilter = 'all';
        let hideCompleted = false;
        let searchQuery = '';
        let priorityFilter = 'all';

        function normalizeItem(item, fallbackType) {
            const durationValue = parseInt(item.duration, 10);
            const priorityMap = { high: 'must', medium: 'should', normal: 'should', low: 'optional' };
            const normalizedDuration = Number.isFinite(durationValue) && durationValue > 0 ? durationValue : 30;
            const startTime = item.startTime || '';
            const endTime = item.endTime || (startTime ? minutesToTime(timeToMinutes(startTime) + normalizedDuration) : '');
            return {
                ...item,
                type: item.type || fallbackType || 'task',
                status: item.status || (item.startTime ? 'scheduled' : 'inbox'),
                priority: priorityMap[item.priority] || item.priority || 'should',
                tag: item.tag || '',
                duration: normalizedDuration,
                location: item.location || '',
                color: item.color || colors[11],
                checklist: item.checklist || [],
                links: item.links || [],
                recurrence: item.recurrence || { freq: 'none', interval: 1, days: [], unit: 'day' },
                exceptions: item.exceptions || [],
                overrides: item.overrides || {},
                completedDates: item.completedDates || [],
                startTime,
                endTime
            };
        }

        // Load saved data and migrate legacy formats.
        function loadData() {
            const saved = localStorage.getItem('plannerData');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.items) {
                    items = data.items || [];
                } else if (data.events || data.tasks || data.reminders) {
                    const migratedEvents = (data.events || []).map(ev => ({
                        id: ev.id,
                        type: 'event',
                        title: ev.title,
                        label: ev.type || 'Event',
                        date: ev.date || '',
                        startTime: ev.time || '',
                        duration: ev.duration || 60,
                        description: ev.description || '',
                        priority: 'should',
                        status: ev.date || ev.time ? 'scheduled' : 'inbox'
                    }));
                    const migratedTasks = (data.tasks || []).map(tsk => ({
                        id: tsk.id,
                        type: 'task',
                        title: tsk.title,
                        label: tsk.type || 'Task',
                        date: tsk.date || '',
                        startTime: tsk.dueTime || '',
                        duration: tsk.duration || 30,
                        description: tsk.description || '',
                        priority: tsk.priority || 'should',
                        status: tsk.date || tsk.dueTime ? 'scheduled' : 'inbox',
                        completed: tsk.completed || false
                    }));
                    items = [...migratedEvents, ...migratedTasks];
                } else {
                    const classes = data.classes || [];
                    const homework = data.homework || [];
                    const appointments = data.appointments || [];
                    const routines = data.routines || [];

                    items = [
                        ...classes.map(cls => ({
                            id: cls.id,
                            type: 'event',
                            title: cls.title,
                            label: 'Class',
                            startTime: cls.time || '',
                            duration: 60,
                            recurrence: { freq: 'weekly', interval: 1, days: cls.recurringDays || [] },
                            description: ''
                        })),
                        ...appointments.map(apt => ({
                            id: apt.id,
                            type: 'event',
                            title: apt.title,
                            label: 'Appointment',
                            date: apt.date,
                            startTime: apt.time || '',
                            duration: 60,
                            description: apt.description || ''
                        })),
                        ...routines.map(rt => ({
                            id: rt.id,
                            type: 'block',
                            title: rt.title,
                            label: 'Routine',
                            startTime: rt.time || '',
                            duration: 60,
                            recurrence: { freq: 'weekly', interval: 1, days: rt.recurringDays || [] },
                            description: ''
                        })),
                        ...homework.map(hw => ({
                            id: hw.id,
                            type: 'task',
                            title: hw.title,
                            label: 'Homework',
                            date: hw.date,
                            startTime: hw.dueTime || '',
                            duration: 30,
                            description: hw.description || '',
                            completed: hw.completed || false
                        }))
                    ];
                }
            }
            items = items.map(item => normalizeItem(item, item.type));
            notificationsEnabled = localStorage.getItem('plannerNotifications') === 'on';
            userName = localStorage.getItem('plannerUserName') || 'Your';
            
            passcodeEnabled = localStorage.getItem('plannerPasscodeEnabled') === 'on';
            passcodeValue = localStorage.getItem('plannerPasscode') || '';
            darkModeEnabled = localStorage.getItem('plannerDarkMode') === 'on';
            currentFilter = localStorage.getItem('plannerFilter') || 'all';
            if (currentFilter === 'reminder') currentFilter = 'all';
            hideCompleted = localStorage.getItem('plannerHideCompleted') === 'on';
            priorityFilter = localStorage.getItem('plannerPriorityFilter') || 'all';
            if (priorityFilter === 'high') priorityFilter = 'must';
        }

        // Save data to localStorage.
        function saveData() {
            localStorage.setItem('plannerData', JSON.stringify({
                items
            }));
        }

        loadData();
        applyUserSettings();
        handleInitialLock();
        updateCurrentDate();
        renderView();
        initializeColorPicker();
        initializeTimePickers();
        refreshTypeSuggestions();
        updateNotificationButton();
        applyFilterUI();
        scheduleReminders();
        setupModalDismissal();
        setupGlobalShortcuts();

        // Switch between day, week, and all views.
        function switchView(view, button) {
            currentView = view;
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (button) button.classList.add('active');

            document.getElementById('dailyView').style.display = view === 'day' ? 'block' : 'none';
            document.getElementById('weekView').classList.toggle('active', view === 'week');
            document.getElementById('monthView').classList.toggle('active', view === 'month');
            renderView();
        }

        function setFilter(filter, button) {
            currentFilter = filter;
            localStorage.setItem('plannerFilter', filter);
            document.querySelectorAll('.chip-button[data-filter]').forEach(btn => {
                btn.classList.toggle('active', btn === button);
            });
            renderView();
        }

        function toggleHideCompleted(button) {
            hideCompleted = !hideCompleted;
            localStorage.setItem('plannerHideCompleted', hideCompleted ? 'on' : 'off');
            if (button) button.classList.toggle('active', hideCompleted);
            renderView();
        }

        function togglePriorityFilter(button) {
            priorityFilter = priorityFilter === 'must' ? 'all' : 'must';
            localStorage.setItem('plannerPriorityFilter', priorityFilter);
            if (button) button.classList.toggle('active', priorityFilter === 'must');
            renderView();
        }

        function updateSearch(value) {
            searchQuery = value;
            renderView();
        }

        function handleQuickCapture() {
            const input = document.getElementById('quickCaptureInput');
            if (!input) return;
            const text = input.value.trim();
            if (!text) return;
            const parsed = parseQuickCapture(text);
            items.push(normalizeItem({
                id: Date.now().toString(),
                type: parsed.type,
                title: parsed.title,
                label: parsed.label,
                date: parsed.date,
                startTime: parsed.startTime,
                endTime: parsed.endTime,
                duration: parsed.duration,
                status: parsed.status,
                priority: parsed.priority
            }, parsed.type));
            saveData();
            refreshTypeSuggestions();
            input.value = '';
            renderView();
            scheduleReminders();
        }

        function parseQuickCapture(text) {
            const lower = text.toLowerCase();
            let type = lower.includes('meet') || lower.includes('meeting') || lower.includes('appointment') ? 'event' : 'task';
            if (lower.startsWith('event:')) type = 'event';
            if (lower.startsWith('task:')) type = 'task';
            const label = type === 'event' ? 'Meeting' : 'Task';
            let priority = 'should';
            if (lower.includes('must')) priority = 'must';
            if (lower.includes('optional')) priority = 'optional';
            let date = formatDate(currentDate);
            if (lower.includes('tomorrow')) {
                const tomorrow = new Date(currentDate);
                tomorrow.setDate(tomorrow.getDate() + 1);
                date = formatDate(tomorrow);
            }
            const dateMatch = lower.match(/(\d{4}-\d{2}-\d{2})/);
            if (dateMatch) date = dateMatch[1];

            const timeRange = lower.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\s*(?:-|–|to)\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
            let startTime = '';
            let endTime = '';
            let duration = 30;
            if (timeRange) {
                const start = buildTimeFromMatch(timeRange[1], timeRange[2], timeRange[3]);
                const end = buildTimeFromMatch(timeRange[4], timeRange[5], timeRange[6] || timeRange[3]);
                startTime = start;
                endTime = end;
                duration = getDurationFromTimes(startTime, endTime) || 60;
            } else {
                const singleTime = lower.match(/(?:at|@)\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
                if (singleTime) {
                    startTime = buildTimeFromMatch(singleTime[1], singleTime[2], singleTime[3]);
                    duration = 60;
                    endTime = minutesToTime(timeToMinutes(startTime) + duration);
                }
            }

            const status = startTime ? 'scheduled' : 'inbox';
            const title = text.replace(/^(event:|task:)/i, '')
                .replace(/(?:tomorrow|today|at\s+\d.*|must|optional)/gi, '')
                .trim() || text;

            return {
                type,
                label,
                title,
                date: status === 'scheduled' ? date : '',
                startTime,
                endTime,
                duration,
                status,
                priority
            };
        }

        function buildTimeFromMatch(hours, minutes, ampm) {
            let h = parseInt(hours, 10);
            const m = minutes ? parseInt(minutes, 10) : 0;
            if (ampm) {
                const period = ampm.toLowerCase();
                if (period === 'pm' && h !== 12) h += 12;
                if (period === 'am' && h === 12) h = 0;
            }
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // Open the settings modal and preload values.
        function openSettingsModal() {
            document.getElementById('userNameInput').value = userName === 'Your' ? '' : userName;
            document.getElementById('darkModeToggle').checked = darkModeEnabled;
            document.getElementById('passcodeToggle').value = passcodeEnabled ? 'on' : 'off';
            document.getElementById('passcodeInput').value = '';
            document.getElementById('passcodeGroup').style.display = passcodeEnabled ? 'block' : 'none';
            setModalState('settingsModal', true);
        }

        // Close the settings modal.
        function closeSettingsModal() {
            setModalState('settingsModal', false);
        }

        function openReviewModal() {
            renderReviewPanel();
            const notes = localStorage.getItem('plannerReviewNotes') || '';
            document.getElementById('reviewNotes').value = notes;
            setModalState('reviewModal', true);
        }

        function closeReviewModal() {
            setModalState('reviewModal', false);
        }

        function saveReviewNotes() {
            const notes = document.getElementById('reviewNotes').value.trim();
            localStorage.setItem('plannerReviewNotes', notes);
            closeReviewModal();
        }

        function renderReviewPanel() {
            const panel = document.getElementById('reviewPanel');
            if (!panel) return;
            const today = formatDate(currentDate);
            const dailyStats = getReviewStats(today, 1);
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
            const weeklyStats = getReviewStats(formatDate(startOfWeek), 7);
            panel.innerHTML = `
                <div class="review-card">
                    <h3>Daily review</h3>
                    <div>Completed: ${dailyStats.completed}</div>
                    <div>Missed: ${dailyStats.missed}</div>
                    <div>Planned vs done: ${dailyStats.plannedMinutes}m / ${dailyStats.completedMinutes}m</div>
                </div>
                <div class="review-card">
                    <h3>Weekly review</h3>
                    <div>Completed: ${weeklyStats.completed}</div>
                    <div>Missed: ${weeklyStats.missed}</div>
                    <div>Planned vs done: ${weeklyStats.plannedMinutes}m / ${weeklyStats.completedMinutes}m</div>
                </div>
            `;
        }

        function getReviewStats(startDateStr, days) {
            let completed = 0;
            let missed = 0;
            let plannedMinutes = 0;
            let completedMinutes = 0;
            for (let i = 0; i < days; i++) {
                const date = new Date(startDateStr + 'T00:00:00');
                date.setDate(date.getDate() + i);
                const dateStr = formatDate(date);
                const dayItems = getItemsForDay(items, dateStr);
                dayItems.forEach(item => {
                    if (item.status === 'scheduled') {
                        plannedMinutes += item.duration || 0;
                        if (isCompleted(item, dateStr)) {
                            completed += 1;
                            completedMinutes += item.duration || 0;
                        } else if (date < new Date() && item.type === 'task') {
                            missed += 1;
                        }
                    }
                });
            }
            return { completed, missed, plannedMinutes, completedMinutes };
        }

        // Save user name and preferences.
        function saveSettings() {
            const nameInput = document.getElementById('userNameInput').value.trim();
            userName = nameInput || 'Your';
            darkModeEnabled = document.getElementById('darkModeToggle').checked;
            passcodeEnabled = document.getElementById('passcodeToggle').value === 'on';
            const passcodeInput = document.getElementById('passcodeInput').value.trim();
            if (passcodeInput) {
                passcodeValue = passcodeInput;
                localStorage.setItem('plannerPasscode', passcodeValue);
            }
            localStorage.setItem('plannerPasscodeEnabled', passcodeEnabled ? 'on' : 'off');
            localStorage.setItem('plannerUserName', userName);
            localStorage.setItem('plannerDarkMode', darkModeEnabled ? 'on' : 'off');
            applyUserSettings();
            closeSettingsModal();
            handleInitialLock();
        }

        // Apply user name to the UI.
        function applyUserSettings() {
            document.getElementById('userNameDisplay').textContent = formatPlannerName(userName);
            document.body.setAttribute('data-mode', darkModeEnabled ? 'dark' : 'light');
        }

        function applyFilterUI() {
            document.querySelectorAll('.chip-button[data-filter]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === currentFilter);
            });
            const hideBtn = document.getElementById('hideCompletedToggle');
            if (hideBtn) hideBtn.classList.toggle('active', hideCompleted);
            const priorityBtn = document.getElementById('priorityToggle');
            if (priorityBtn) priorityBtn.classList.toggle('active', priorityFilter === 'must');
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchQuery) searchInput.value = searchQuery;
        }


        // Format the header name with a possessive.
        function formatPlannerName(name) {
            if (!name || name.toLowerCase() === 'your') return 'Your';
            const trimmed = name.trim();
            if (!trimmed) return 'Your';
            const lastChar = trimmed.charAt(trimmed.length - 1).toLowerCase();
            if (lastChar === 's') return `${trimmed}'`;
            return `${trimmed}'s`;
        }

        // Show or hide passcode setup field when toggled.
        function updatePasscodeVisibility() {
            const enabled = document.getElementById('passcodeToggle').value === 'on';
            document.getElementById('passcodeGroup').style.display = enabled ? 'block' : 'none';
        }

        // Lock the app on load if passcode is enabled.
        function handleInitialLock() {
            if (!passcodeEnabled || !passcodeValue) return;
            openLockModal();
        }

        // Open the lock modal.
        function openLockModal() {
            passcodeEntry = '';
            updatePasscodeDots();
            setModalState('lockModal', true);
        }

        // Close the lock modal.
        function closeLockModal() {
            setModalState('lockModal', false);
        }

        // Unlock the app if the passcode matches.
        function unlockApp() {
            if (passcodeEntry && passcodeEntry === passcodeValue) {
                closeLockModal();
            } else {
                alert('Incorrect passcode.');
                passcodeEntry = '';
                updatePasscodeDots();
            }
        }

        // Add a digit to the passcode entry.
        function pressPasscodeKey(digit) {
            if (passcodeEntry.length >= 8) return;
            passcodeEntry += digit;
            updatePasscodeDots();
            if (passcodeEntry.length >= 4 && passcodeEntry === passcodeValue) {
                unlockApp();
            }
        }

        // Clear the passcode entry.
        function clearPasscodeEntry() {
            passcodeEntry = '';
            updatePasscodeDots();
        }

        // Remove the last passcode digit.
        function backspacePasscode() {
            passcodeEntry = passcodeEntry.slice(0, -1);
            updatePasscodeDots();
        }

        // Update the visual dot display for passcode entry.
        function updatePasscodeDots() {
            const dots = document.querySelectorAll('#passcodeDots .passcode-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('filled', index < passcodeEntry.length);
            });
        }
        // Move the current date backward or forward by a number of days.
        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateCurrentDate();
            renderView();
        }

        // Jump the calendar back to today.
        function goToday() {
            currentDate = new Date();
            updateCurrentDate();
            renderView();
        }

        // Update the header date display.
        function updateCurrentDate() {
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = currentDate.toLocaleDateString('en-US', options);
        }

        // Render the active view.
        function renderView() {
            if (currentView === 'day') {
                renderDailyView();
            } else if (currentView === 'week') {
                renderWeekView();
            } else {
                renderMonthView();
            }
            setupScrollShadows();
            setupDaySwipe();
            setupRangeSwipe();
        }

        function itemMatchesSearch(item) {
            if (!searchQuery) return true;
            const term = searchQuery.trim().toLowerCase();
            if (!term) return true;
            const fields = [item.title, item.label, item.description, item.tag, item.location];
            return fields.some(field => field && field.toLowerCase().includes(term));
        }

        function applyFilters(items, dateStr) {
            return items.filter(item => {
                if (currentFilter !== 'all') {
                    if (currentFilter === 'inbox' && item.status !== 'inbox') return false;
                    if (currentFilter === 'block' && item.type !== 'block') return false;
                    if (currentFilter !== 'inbox' && currentFilter !== 'block' && item.type !== currentFilter) return false;
                }
                if (hideCompleted && isCompleted(item, dateStr)) return false;
                if (priorityFilter === 'must' && item.priority !== 'must') return false;
                if (!itemMatchesSearch(item)) return false;
                return true;
            });
        }

        // Render the daily view with hourly slots and a tasks panel.
        function renderDailyView() {
            const container = document.getElementById('dailyView');
            container.innerHTML = '';

            const dateStr = formatDate(currentDate);
            const dayItems = getItemsForDay(items, dateStr);
            const scheduledItems = dayItems.filter(item => item.status !== 'inbox');
            const inboxItems = items.filter(item => item.type === 'task' && item.status === 'inbox');
            const filteredScheduled = applyFilters(scheduledItems, dateStr);
            const filteredInbox = applyFilters(inboxItems, dateStr);
            const slotHeight = 56;

            const layout = document.createElement('div');
            layout.className = 'day-layout';

            if (filteredScheduled.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'day-empty';
                empty.textContent = 'No scheduled items for this day.';
                layout.appendChild(empty);
            }

            const insightRow = document.createElement('div');
            insightRow.className = 'day-insights';

            const nextCard = document.createElement('div');
            nextCard.className = 'insight-card';
            const nextItem = getNextItemForDay(filteredScheduled, dateStr);
            const nextLabel = nextItem ? `${nextItem.title}${nextItem.startTime ? ' · ' + formatTime(nextItem.startTime) : ''}` : 'You are clear.';
            nextCard.innerHTML = `
                <div class="insight-label">Next up</div>
                <div class="insight-value">${nextLabel}</div>
                <div class="insight-subtle">${nextItem ? (nextItem.label || nextItem.type) : 'No upcoming items found.'}</div>
            `;
            insightRow.appendChild(nextCard);

            const taskCard = document.createElement('div');
            taskCard.className = 'insight-card';
            const dayTasks = dayItems.filter(item => item.type === 'task');
            const completedTasks = dayTasks.filter(task => isCompleted(task, dateStr)).length;
            taskCard.innerHTML = `
                <div class="insight-label">Task progress</div>
                <div class="insight-value">${completedTasks} of ${dayTasks.length || 0}</div>
                <div class="insight-subtle">${dayTasks.length ? `${dayTasks.length - completedTasks} remaining today` : 'Add a task to get started.'}</div>
            `;
            insightRow.appendChild(taskCard);

            const focusCard = document.createElement('div');
            focusCard.className = 'insight-card';
            const focusMinutes = dayTasks.reduce((sum, task) => sum + (parseInt(task.duration, 10) || 0), 0);
            const focusLabel = formatDuration(focusMinutes);
            focusCard.innerHTML = `
                <div class="insight-label">Focus load</div>
                <div class="insight-value">${focusLabel || '0m'}</div>
                <div class="insight-subtle">${focusMinutes ? 'Planned minutes today' : 'Add duration to tasks to track workload.'}</div>
            `;
            insightRow.appendChild(focusCard);

            layout.appendChild(insightRow);

            const timeScroll = document.createElement('div');
            timeScroll.className = 'time-scroll';

            const grid = document.createElement('div');
            grid.className = 'time-grid';
            grid.style.position = 'relative';

            for (let hour = 0; hour < 24; hour++) {
                const slot = document.createElement('div');
                slot.className = 'time-slot';

                const label = document.createElement('div');
                label.className = 'time-label';
                label.textContent = formatHourLabel(hour);

                const slotEvents = document.createElement('div');
                slotEvents.className = 'slot-events slot-interactive';
                const dropZone = document.createElement('div');
                dropZone.className = 'slot-drop';
                dropZone.dataset.hour = String(hour);
                dropZone.addEventListener('dragover', (event) => {
                    event.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
                dropZone.addEventListener('drop', (event) => {
                    event.preventDefault();
                    dropZone.classList.remove('drag-over');
                    const itemId = event.dataTransfer.getData('text/plain');
                    if (!itemId) return;
                    const startMinutes = hour * 60;
                    scheduleItemToTime(itemId, dateStr, startMinutes);
                });
                slotEvents.appendChild(dropZone);

                slot.appendChild(label);
                slot.appendChild(slotEvents);
                grid.appendChild(slot);

                slotEvents.addEventListener('click', (event) => {
                    if (event.target && event.target.closest('.time-block')) return;
                    const rect = slotEvents.getBoundingClientRect();
                    const offset = event.clientY - rect.top;
                    const ratio = Math.min(Math.max(offset / rect.height, 0), 1);
                    const minute = Math.min(55, Math.round((ratio * 60) / 5) * 5);
                    openAddModalWithTime(hour, minute);
                });
            }

            filteredScheduled.forEach(item => {
                if (!item.startTime) return;
                const block = buildTimeBlock(item, dateStr, slotHeight);
                grid.appendChild(block);
            });

            timeScroll.appendChild(grid);
            layout.appendChild(timeScroll);

            const tasksPanel = document.createElement('div');
            tasksPanel.className = 'day-tasks-panel';
            const panelDate = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const panelTitle = isToday(currentDate) ? "Today's Scheduled Tasks" : `Tasks · ${panelDate}`;
            tasksPanel.innerHTML = `<div class="panel-title">${panelTitle}</div>`;

            const taskList = document.createElement('div');
            taskList.className = 'task-list';

            const visibleTasks = filteredScheduled.filter(item => item.type === 'task')
                .sort((a, b) => getPriorityRank(a.priority) - getPriorityRank(b.priority));
            if (visibleTasks.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'helper-text';
                empty.textContent = dayTasks.length === 0 ? 'No tasks for today.' : 'No scheduled tasks match your filters.';
                tasksPanel.appendChild(empty);
            } else {
                visibleTasks.forEach(task => {
                    const row = document.createElement('div');
                    const completed = isCompleted(task, dateStr);
                    row.className = `task-row ${completed ? 'completed' : ''}`;
                    row.dataset.type = 'task';
                    row.dataset.id = task.id;
                    row.dataset.date = dateStr;
                    const priority = task.priority || 'should';
                    const durationLabel = formatDuration(task.duration);
                    const metaParts = [];
                    if (task.startTime) metaParts.push(formatTime(task.startTime));
                    if (task.tag) metaParts.push(`#${task.tag}`);
                    if (durationLabel) metaParts.push(durationLabel);
                    row.innerHTML = `
                        <input class="task-checkbox" type="checkbox" ${completed ? 'checked' : ''}>
                        <div class="priority-dot ${priority === 'should' ? '' : priority}"></div>
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                            ${metaParts.length ? `<div class="task-meta">${metaParts.join(' · ')}</div>` : ''}
                        </div>
                    `;
                    const checkbox = row.querySelector('.task-checkbox');
                    checkbox.addEventListener('change', () => toggleComplete('task', task.id, dateStr, row));
                    row.addEventListener('click', (event) => {
                        if (event.target && event.target.matches('input')) return;
                        toggleComplete('task', task.id, dateStr, row);
                    });
                    taskList.appendChild(row);
                });
                tasksPanel.appendChild(taskList);
            }

            const rowCount = Math.max(visibleTasks.length, 1);
            const baseHeight = 72;
            const rowHeight = 44;
            const desiredHeight = baseHeight + (rowCount * rowHeight);
            const minHeight = 120;
            const maxHeight = Math.round(window.innerHeight * 0.28);
            const finalHeight = Math.min(Math.max(desiredHeight, minHeight), maxHeight);
            tasksPanel.style.maxHeight = `${finalHeight}px`;

            layout.appendChild(tasksPanel);

            const inboxPanel = document.createElement('div');
            inboxPanel.className = 'inbox-panel';
            inboxPanel.innerHTML = `
                <div class="panel-title">Inbox Tasks</div>
                <button class="btn btn-secondary" type="button" onclick="autoScheduleInbox('${dateStr}')">Auto-schedule</button>
            `;
            inboxPanel.addEventListener('dragover', (event) => event.preventDefault());
            inboxPanel.addEventListener('drop', (event) => {
                event.preventDefault();
                const itemId = event.dataTransfer.getData('text/plain');
                const dateDrop = event.dataTransfer.getData('text/date');
                if (itemId) unscheduleItem(itemId, dateDrop || '');
            });
            if (filteredInbox.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'helper-text';
                empty.textContent = 'Inbox is clear.';
                inboxPanel.appendChild(empty);
            } else {
                filteredInbox
                    .sort((a, b) => getPriorityRank(a.priority) - getPriorityRank(b.priority))
                    .forEach(task => {
                    const row = document.createElement('div');
                    row.className = 'inbox-item';
                    row.draggable = true;
                    row.dataset.id = task.id;
                    row.addEventListener('dragstart', (event) => {
                        event.dataTransfer.setData('text/plain', task.id);
                    });
                    row.innerHTML = `
                        <span>${task.title}</span>
                        ${task.priority ? `<span class="meta-chip ${getPriorityClass(task.priority)}">${getPriorityLabel(task.priority)}</span>` : ''}
                    `;
                    row.addEventListener('click', () => openEditModal(task.type, task.id, dateStr));
                    inboxPanel.appendChild(row);
                });
            }
            layout.appendChild(inboxPanel);
            container.appendChild(layout);

            startNowLineTimer();
            updateNowLine();
            requestAnimationFrame(() => {
                requestAnimationFrame(() => scrollToCurrentTime(true));
            });
        }

        // Scroll the day view to keep the last two hours visible.
        function scrollToCurrentTime(force) {
            if (!isToday(currentDate)) return;
            const timeScroll = document.querySelector('.time-scroll');
            if (!timeScroll) return;
            const line = document.querySelector('.now-line');
            const now = new Date();
            const hour = now.getHours();
            if (!line) return;
            const lineTop = line.getBoundingClientRect().top + timeScroll.scrollTop - timeScroll.getBoundingClientRect().top;
            const target = Math.max(0, lineTop - (timeScroll.clientHeight * 0.20));
            if (force || hour !== lastAutoScrollHour) {
                timeScroll.scrollTo({ top: target, behavior: 'smooth' });
                lastAutoScrollHour = hour;
            }
        }

        // Start or restart the timer that keeps the now-line up to date.
        function startNowLineTimer() {
            if (nowLineTimer) {
                clearInterval(nowLineTimer);
            }
            nowLineTimer = setInterval(() => {
                updateNowLine();
                autoScrollIfHourChanged();
            }, 60000);
        }

        // Update the position of the current time line in day view.
        function updateNowLine() {
            const grid = document.querySelector('.time-grid');
            if (!grid) return;

            let line = document.querySelector('.now-line');
            if (!isToday(currentDate)) {
                if (line) line.style.display = 'none';
                return;
            }

            if (!line) {
                line = document.createElement('div');
                line.className = 'now-line';
                grid.appendChild(line);
            }

            line.style.display = 'block';

            const now = new Date();
            const hour = now.getHours();
            const minutes = now.getMinutes();
            const slots = grid.querySelectorAll('.time-slot');
            const slot = slots[hour];
            if (!slot) return;

            const nextSlot = slots[hour + 1] || slot;
            const hourHeight = nextSlot.offsetTop - slot.offsetTop || slot.offsetHeight;
            const top = slot.offsetTop + (minutes / 60) * hourHeight;
            line.style.top = `${top}px`;
        }

        // Auto-scroll when the hour changes while on today's view.
        function autoScrollIfHourChanged() {
            if (!isToday(currentDate)) return;
            const now = new Date();
            const hour = now.getHours();
            if (lastAutoScrollHour === null) {
                lastAutoScrollHour = hour;
                return;
            }
            if (hour !== lastAutoScrollHour) {
                scrollToCurrentTime(true);
            }
        }

        // Check if a date is today.
        function isToday(date) {
            const now = new Date();
            return date.getFullYear() === now.getFullYear() &&
                date.getMonth() === now.getMonth() &&
                date.getDate() === now.getDate();
        }

        // Render the week view with scheduled items.
        function renderWeekView() {
            const container = document.getElementById('weekView');
            container.innerHTML = '<div class="week-grid"></div>';
            const grid = container.querySelector('.week-grid');

            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = formatDate(date);

                const dayItems = getItemsForDay(items, dateStr);
                const scheduledItems = dayItems.filter(item => item.status !== 'inbox');
                const filteredItems = applyFilters(scheduledItems, dateStr);

                const dayCol = document.createElement('div');
                dayCol.className = `day-column ${isToday(date) ? 'today' : ''}`;

                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                dayCol.innerHTML = `
                    <div class="day-header">
                        <div class="day-name">${dayName}</div>
                        <div class="day-date">${dayDate}</div>
                    </div>
                    <div class="day-items"></div>
                `;

                const itemsContainer = dayCol.querySelector('.day-items');

                filteredItems.forEach(item => {
                    const pill = document.createElement('div');
                    const completed = isCompleted(item, dateStr);
                    pill.className = `homework-item swipe-card ${completed ? 'completed' : ''}`;
                    pill.style.borderLeftColor = item.color || colors[11];
                    pill.dataset.type = item.type;
                    pill.dataset.id = item.id;
                    pill.dataset.date = dateStr;
                    const timeLabel = item.startTime || '';
                    const metaParts = [];
                    if (item.priority && item.priority !== 'should') metaParts.push(getPriorityLabel(item.priority));
                    if (item.tag) metaParts.push(`#${item.tag}`);
                    if (item.location) metaParts.push(item.location);
                    pill.innerHTML = `
                        <div class="homework-class">${item.label || item.type}</div>
                        <div>${item.title}${timeLabel ? ' · ' + formatTime(timeLabel) : ''}</div>
                        ${metaParts.length ? `<div class="event-meta">${metaParts.join(' · ')}</div>` : ''}
                    `;
                    attachSwipeAndTap(pill);
                    itemsContainer.appendChild(pill);
                });

                if (itemsContainer.children.length === 0) {
                    itemsContainer.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px; padding: 8px 0;">No items</div>';
                }

                grid.appendChild(dayCol);
            }
        }

        // Render the month view for scheduled items.
        function renderMonthView() {
            const container = document.getElementById('monthView');
            container.innerHTML = '';

            const header = document.createElement('div');
            header.className = 'month-header';
            const monthLabel = currentDate.toLocaleDateString('en-US', { month: 'long' });
            const yearLabel = currentDate.getFullYear();
            header.innerHTML = `
                <div class="month-title">${monthLabel}</div>
                <div class="month-subtitle">${yearLabel}</div>
            `;

            const grid = document.createElement('div');
            grid.className = 'month-grid';

            const firstOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startWeekday = firstOfMonth.getDay();
            const totalDays = lastOfMonth.getDate();

            for (let i = 0; i < startWeekday; i++) {
                const spacer = document.createElement('div');
                spacer.className = 'month-cell';
                spacer.style.opacity = '0.4';
                spacer.innerHTML = '<div class="month-day">&nbsp;</div>';
                grid.appendChild(spacer);
            }

            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const dateStr = formatDate(date);
                const rawItems = getItemsForDay(items, dateStr).filter(item => item.status !== 'inbox');
                const itemsForDay = applyFilters(rawItems, dateStr);

                const cell = document.createElement('div');
                const isSelected = dateStr === formatDate(currentDate);
                cell.className = `month-cell ${isToday(date) ? 'today' : ''} ${isSelected ? 'selected' : ''}`.trim();

                const dayLabel = document.createElement('div');
                dayLabel.className = 'month-day';
                dayLabel.textContent = date.toLocaleDateString('en-US', { weekday: 'short' }) + ` ${day}`;
                cell.appendChild(dayLabel);

                const itemList = document.createElement('div');
                itemList.className = 'month-items';

                itemsForDay.slice(0, 3).forEach(item => {
                    const pill = document.createElement('div');
                    const timeLabel = item.startTime || '';
                    pill.className = 'month-pill';
                    pill.style.borderLeftColor = item.color || colors[11];
                    pill.dataset.type = item.type;
                    pill.dataset.id = item.id;
                    pill.dataset.date = dateStr;
                    const priorityMark = item.priority === 'must' ? '★ ' : item.priority === 'should' ? '• ' : '';
                    pill.textContent = `${priorityMark}${item.title}${timeLabel ? ' · ' + formatTime(timeLabel) : ''}`;
                    attachSwipeAndTap(pill);
                    itemList.appendChild(pill);
                });

                if (itemsForDay.length > 3) {
                    const more = document.createElement('div');
                    more.className = 'month-empty';
                    more.textContent = `+${itemsForDay.length - 3} more`;
                    itemList.appendChild(more);
                }

                if (itemsForDay.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'month-empty';
                    empty.textContent = rawItems.length === 0 ? 'No items' : 'Filtered out';
                    itemList.appendChild(empty);
                }

                cell.appendChild(itemList);
                grid.appendChild(cell);
            }

            container.appendChild(header);
            container.appendChild(grid);
        }

        function buildItemMeta(item) {
            const timeLabel = item.startTime || '';
            const durationLabel = formatDuration(item.duration);
            const parts = [];
            if (timeLabel) parts.push(formatTime(timeLabel));
            if (item.label) parts.push(item.label);
            if (item.tag) parts.push(`#${item.tag}`);
            if (item.location) parts.push(item.location);
            if (durationLabel) parts.push(durationLabel);
            if (item.checklist && item.checklist.length) parts.push(`${item.checklist.length} checklist`);
            if (item.links && item.links.length) parts.push(`${item.links.length} link${item.links.length > 1 ? 's' : ''}`);
            const priority = item.priority || 'should';
            const priorityChip = priority !== 'should'
                ? `<span class="meta-chip ${getPriorityClass(priority)}">${getPriorityLabel(priority)}</span>`
                : '';
            const partChips = parts.map(part => `<span class="meta-chip">${part}</span>`).join('');
            if (!priorityChip && !partChips) return '';
            return `<div class="event-meta meta-row">${priorityChip}${partChips}</div>`;
        }

        function buildTimeBlock(item, dateStr, slotHeight) {
            const block = document.createElement('div');
            const startMinutes = timeToMinutes(item.startTime);
            const duration = item.endTime ? getDurationFromTimes(item.startTime, item.endTime) : (item.duration || 30);
            const height = Math.max((duration / 60) * slotHeight, 40);
            const completed = isCompleted(item, dateStr);
            block.className = `time-block type-${item.type} ${item.type === 'block' ? 'focus-block' : ''} ${completed ? 'completed' : ''}`;
            block.style.top = `${(startMinutes / 60) * slotHeight}px`;
            block.style.height = `${height}px`;
            block.style.borderLeftColor = item.color || colors[11];
            block.dataset.id = item.id;
            block.dataset.type = item.type;
            block.draggable = true;
            const showResize = item.type !== 'event';
            block.innerHTML = `
                <div class="block-title">${item.title}</div>
                <div class="block-meta">${formatTime(item.startTime)} · ${formatDuration(duration)}${item.location ? ` · ${item.location}` : ''}</div>
                ${showResize ? '<div class="resize-handle"></div>' : ''}
            `;
            block.addEventListener('click', () => openEditModal(item.type, item.id, dateStr));
            block.addEventListener('dragstart', (event) => {
                event.dataTransfer.setData('text/plain', item.id);
                event.dataTransfer.setData('text/date', dateStr);
            });

            const handle = block.querySelector('.resize-handle');
            let resizing = false;
            let startY = 0;
            let startDuration = duration;

            if (!handle) return block;
            const onMove = (event) => {
                if (!resizing) return;
                const delta = event.clientY - startY;
                const minutesDelta = Math.round((delta / slotHeight) * 60 / 15) * 15;
                const newDuration = Math.max(15, startDuration + minutesDelta);
                if (!canScheduleTime(item.id, dateStr, startMinutes, newDuration)) return;
                block.style.height = `${Math.max((newDuration / 60) * slotHeight, 40)}px`;
            };

            const onUp = (event) => {
                if (!resizing) return;
                resizing = false;
                document.removeEventListener('pointermove', onMove);
                document.removeEventListener('pointerup', onUp);
                const delta = event.clientY - startY;
                const minutesDelta = Math.round((delta / slotHeight) * 60 / 15) * 15;
                const newDuration = Math.max(15, startDuration + minutesDelta);
                if (canScheduleTime(item.id, dateStr, startMinutes, newDuration)) {
                    updateItemSchedule(item.id, dateStr, item.startTime, newDuration);
                }
            };

            handle.addEventListener('pointerdown', (event) => {
                event.stopPropagation();
                resizing = true;
                startY = event.clientY;
                startDuration = duration;
                document.addEventListener('pointermove', onMove);
                document.addEventListener('pointerup', onUp);
            });
            return block;
        }

        function canScheduleTime(itemId, dateStr, startMinutes, duration) {
            const endMinutes = startMinutes + duration;
            const dayItems = getItemsForDay(items, dateStr);
            return !dayItems.some(entry => {
                if (entry.id === itemId) return false;
                if (!entry.startTime) return false;
                const entryStart = timeToMinutes(entry.startTime);
                const entryDuration = entry.endTime ? getDurationFromTimes(entry.startTime, entry.endTime) : (entry.duration || 30);
                const entryEnd = entryStart + entryDuration;
                const overlaps = startMinutes < entryEnd && endMinutes > entryStart;
                if (!overlaps) return false;
                if (entry.type === 'block') return true;
                return true;
            });
        }

        function updateItemSchedule(itemId, dateStr, startTime, duration) {
            const item = items.find(entry => entry.id === itemId);
            if (!item) return;
            item.status = 'scheduled';
            item.date = dateStr;
            item.startTime = startTime;
            item.endTime = minutesToTime(timeToMinutes(startTime) + duration);
            item.duration = duration;
            saveData();
            renderView();
        }

        function unscheduleItem(itemId, dateStr) {
            const item = items.find(entry => entry.id === itemId);
            if (!item || item.type !== 'task') return;
            if (item.recurrence && item.recurrence.freq !== 'none' && dateStr) {
                item.exceptions = item.exceptions || [];
                if (!item.exceptions.includes(dateStr)) {
                    item.exceptions.push(dateStr);
                }
                saveData();
                renderView();
                return;
            }
            item.status = 'inbox';
            item.date = '';
            item.startTime = '';
            item.endTime = '';
            saveData();
            renderView();
        }

        function scheduleItemToTime(itemId, dateStr, startMinutes) {
            const item = items.find(entry => entry.id === itemId);
            if (!item) return;
            const duration = item.duration || 30;
            if (!canScheduleTime(itemId, dateStr, startMinutes, duration)) {
                alert('That time is blocked by another event or focus block.');
                return;
            }
            if (item.recurrence && item.recurrence.freq !== 'none') {
                item.overrides = item.overrides || {};
                item.overrides[dateStr] = {
                    ...item,
                    date: dateStr,
                    startTime: minutesToTime(startMinutes),
                    endTime: minutesToTime(startMinutes + duration),
                    status: 'scheduled'
                };
                saveData();
                renderView();
                return;
            }
            updateItemSchedule(itemId, dateStr, minutesToTime(startMinutes), duration);
        }

        function autoScheduleInbox(dateStr) {
            const inboxTasks = items.filter(item => item.type === 'task' && item.status === 'inbox')
                .sort((a, b) => getPriorityRank(a.priority) - getPriorityRank(b.priority));
            let currentMinutes = 8 * 60;
            const endOfDay = 18 * 60;
            inboxTasks.forEach(task => {
                const duration = task.duration || 30;
                while (currentMinutes + duration <= endOfDay) {
                    if (canScheduleTime(task.id, dateStr, currentMinutes, duration)) {
                        updateItemSchedule(task.id, dateStr, minutesToTime(currentMinutes), duration);
                        currentMinutes += duration;
                        break;
                    }
                    currentMinutes += 15;
                }
            });
        }

        // Build a swipeable card element for items in list views.
        function buildCard(item, className, dateStr) {
            const card = document.createElement('div');
            const completed = isCompleted(item, dateStr);
            card.className = `${className} swipe-card ${completed ? 'completed' : ''}`;
            card.style.borderLeftColor = item.color || colors[11];
            card.dataset.type = item.type || 'task';
            card.dataset.id = item.id;
            card.dataset.date = dateStr;
            card.innerHTML = `
                <div class="event-title">${item.title}</div>
                ${buildItemMeta(item)}
                ${item.description ? `<div class="event-meta">${item.description}</div>` : ''}
                <div class="card-check">✓</div>
            `;
            attachSwipeAndTap(card);
            return card;
        }

        // Add swipe-to-complete/delete and tap-to-edit behavior.
        function attachSwipeAndTap(element) {
            let startX = 0;
            let startY = 0;
            let moved = false;

            element.addEventListener('pointerdown', (e) => {
                startX = e.clientX;
                startY = e.clientY;
                moved = false;
                element.setPointerCapture(e.pointerId);
            });

            element.addEventListener('pointermove', (e) => {
                if (!startX && !startY) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                if (Math.abs(dy) > 12 && Math.abs(dy) > Math.abs(dx)) {
                    moved = true;
                    return;
                }
                if (Math.abs(dx) > 12 && Math.abs(dx) > Math.abs(dy)) {
                    moved = true;
                    element.style.transform = `translateX(${dx}px)`;
                    element.style.opacity = `${1 - Math.min(Math.abs(dx) / 160, 0.6)}`;
                }
            });

            element.addEventListener('pointerup', (e) => {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                element.releasePointerCapture(e.pointerId);
                element.style.transform = '';
                element.style.opacity = '';

                if (moved && Math.abs(dy) > Math.abs(dx)) {
                    startX = 0;
                    startY = 0;
                    return;
                }
                if (!moved || Math.abs(dx) < 60 || Math.abs(dx) < Math.abs(dy)) {
                    openEditFromElement(element);
                } else if (dx > 60) {
                    completeFromElement(element);
                } else if (dx < -60) {
                    deleteFromElement(element);
                }

                startX = 0;
                startY = 0;
            });

            element.addEventListener('pointercancel', () => {
                element.style.transform = '';
                element.style.opacity = '';
                startX = 0;
                startY = 0;
            });
        }

        // Open the edit modal from a rendered element.
        function openEditFromElement(element) {
            const type = element.dataset.type;
            const id = element.dataset.id;
            const dateStr = element.dataset.date;
            openEditModal(type, id, dateStr);
        }

        // Complete an item from its element.
        function completeFromElement(element) {
            const type = element.dataset.type;
            const id = element.dataset.id;
            const dateStr = element.dataset.date;
            toggleComplete(type, id, dateStr, element);
        }

        // Delete an item from its element.
        function deleteFromElement(element) {
            const id = element.dataset.id;
            deleteItem(id);
        }

        function getItemsForDay(list, dateStr) {
            return list.map(item => getOccurrence(item, dateStr)).filter(Boolean);
        }

        function getOccurrence(item, dateStr) {
            const recurrence = item.recurrence || { freq: 'none', interval: 1, days: [] };
            const baseDate = item.date || dateStr;
            if (recurrence.freq === 'none') {
                if ((item.status === 'scheduled' || item.status === 'completed') && item.date === dateStr) {
                    return { ...item, date: dateStr };
                }
                return null;
            }

            if (item.status === 'inbox') return null;
            if (item.exceptions && item.exceptions.includes(dateStr)) return null;

            if (!matchesRecurrence(item, dateStr, baseDate)) return null;

            const override = item.overrides && item.overrides[dateStr] ? item.overrides[dateStr] : {};
            return { ...item, ...override, date: dateStr };
        }

        function matchesRecurrence(item, dateStr, startDate) {
            const recurrence = item.recurrence || { freq: 'none', interval: 1, days: [] };
            const date = new Date(dateStr + 'T00:00:00');
            const start = new Date((item.date || startDate || dateStr) + 'T00:00:00');
            const interval = recurrence.interval || 1;
            if (recurrence.freq === 'daily' || recurrence.freq === 'day') {
                const diffDays = Math.floor((date - start) / (24 * 60 * 60 * 1000));
                return diffDays >= 0 && diffDays % interval === 0;
            }
            if (recurrence.freq === 'weekly' || recurrence.freq === 'week') {
                const diffWeeks = Math.floor((date - start) / (7 * 24 * 60 * 60 * 1000));
                const days = recurrence.days && recurrence.days.length ? recurrence.days : [start.getDay()];
                return diffWeeks >= 0 && diffWeeks % interval === 0 && days.includes(date.getDay());
            }
            if (recurrence.freq === 'monthly' || recurrence.freq === 'month') {
                const diffMonths = (date.getFullYear() - start.getFullYear()) * 12 + (date.getMonth() - start.getMonth());
                return diffMonths >= 0 && diffMonths % interval === 0 && date.getDate() === start.getDate();
            }
            return false;
        }

        function isCompleted(item, dateStr) {
            if (item.status === 'completed') return true;
            if (item.recurrence && item.recurrence.freq !== 'none') {
                return item.completedDates && item.completedDates.includes(dateStr);
            }
            return item.completed || false;
        }

        function toggleComplete(type, id, dateStr, element) {
            const item = items.find(entry => entry.id === id);
            if (!item) return;
            if (item.recurrence && item.recurrence.freq !== 'none') {
                item.completedDates = item.completedDates || [];
                if (item.completedDates.includes(dateStr)) {
                    item.completedDates = item.completedDates.filter(d => d !== dateStr);
                } else {
                    item.completedDates.push(dateStr);
                }
            } else {
                if (item.status === 'completed') {
                    item.status = item.startTime ? 'scheduled' : 'inbox';
                } else {
                    item.status = 'completed';
                }
            }
            saveData();
            if (element) {
                element.classList.add('just-completed');
                if (navigator.vibrate) navigator.vibrate(20);
                setTimeout(() => element.classList.remove('just-completed'), 350);
                setTimeout(() => renderView(), 220);
                return;
            }
            renderView();
        }

        // Open the add modal with defaults.
        function openAddModal() {
            editingItem = null;
            document.getElementById('modalTitle').textContent = 'Add Item';
            document.getElementById('saveButton').textContent = 'Add';
            document.getElementById('deleteButton').style.display = 'none';
            document.getElementById('seriesGroup').style.display = 'none';
            setModalState('addModal', true);
            document.getElementById('itemDate').value = formatDate(currentDate);
            document.getElementById('itemCategory').value = 'task';
            document.getElementById('itemKind').value = '';
            document.getElementById('itemRepeats').value = 'none';
            document.getElementById('repeatInterval').value = '1';
            document.getElementById('repeatUnit').value = 'day';
            document.getElementById('itemStatus').value = 'inbox';
            document.getElementById('itemPriority').value = 'should';
            document.getElementById('itemTag').value = '';
            document.getElementById('itemDuration').value = '';
            document.getElementById('itemLocation').value = '';
            document.getElementById('itemChecklist').value = '';
            document.getElementById('itemLinks').value = '';
            clearTimePicker('itemStartTime');
            clearTimePicker('itemEndTime');
            selectColor(0);
            updateFormFields();
            setTimeout(() => document.getElementById('itemTitle').focus(), 0);
        }

        // Open add modal pre-filled with a time from the timeline.
        function openAddModalWithTime(hour, minute) {
            openAddModal();
            const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            setTimePickerValue('itemStartTime', time);
            setTimePickerValue('itemEndTime', shiftTime(time, 60));
            document.getElementById('itemStatus').value = 'scheduled';
        }

        // Open the edit modal and load item data.
        function openEditModal(type, id, dateStr) {
            const item = items.find(entry => entry.id === id);
            if (!item) return;
            const occurrence = dateStr && item.overrides && item.overrides[dateStr] ? { ...item, ...item.overrides[dateStr] } : item;

            editingItem = { type, id, dateStr };
            document.getElementById('modalTitle').textContent = 'Edit Item';
            document.getElementById('saveButton').textContent = 'Save';
            document.getElementById('deleteButton').style.display = 'inline-block';

            document.getElementById('itemCategory').value = occurrence.type || 'task';
            document.getElementById('itemKind').value = occurrence.label || '';
            document.getElementById('itemTitle').value = occurrence.title || '';
            document.getElementById('itemDate').value = occurrence.date || (dateStr || formatDate(currentDate));
            document.getElementById('itemDescription').value = occurrence.description || '';
            document.getElementById('itemPriority').value = occurrence.priority || 'should';
            document.getElementById('itemTag').value = occurrence.tag || '';
            document.getElementById('itemDuration').value = occurrence.duration || '';
            document.getElementById('itemLocation').value = occurrence.location || '';
            document.getElementById('itemStatus').value = occurrence.status || 'inbox';
            document.getElementById('itemChecklist').value = (occurrence.checklist || []).join('\n');
            document.getElementById('itemLinks').value = (occurrence.links || []).join(', ');
            setTimePickerValue('itemStartTime', occurrence.startTime || '');
            const computedEnd = occurrence.endTime || (occurrence.startTime ? shiftTime(occurrence.startTime, occurrence.duration || 30) : '');
            setTimePickerValue('itemEndTime', computedEnd || '');

            const recurrence = item.recurrence || { freq: 'none', interval: 1, days: [] };
            const repeatValue = recurrence.freq || 'none';
            document.getElementById('itemRepeats').value = repeatValue;
            document.getElementById('repeatInterval').value = String(recurrence.interval || 1);
            document.getElementById('repeatUnit').value = recurrence.unit || 'day';

            document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
            if (recurrence.days) {
                document.querySelectorAll('.day-checkbox').forEach(cb => {
                    cb.checked = recurrence.days.includes(parseInt(cb.value, 10));
                });
            }

            document.querySelectorAll('.color-option').forEach((opt, index) => {
                opt.classList.toggle('selected', item.color === colors[index]);
            });

            document.getElementById('seriesGroup').style.display = recurrence.freq && recurrence.freq !== 'none' ? 'block' : 'none';
            document.getElementById('applySeriesToggle').checked = true;

            updateFormFields();
            setModalState('addModal', true);
            setTimeout(() => document.getElementById('itemTitle').focus(), 0);
        }

        function skipOccurrence() {
            if (!editingItem) return;
            const item = items.find(entry => entry.id === editingItem.id);
            if (!item || !editingItem.dateStr) return;
            item.exceptions = item.exceptions || [];
            if (!item.exceptions.includes(editingItem.dateStr)) {
                item.exceptions.push(editingItem.dateStr);
            }
            saveData();
            closeAddModal();
            renderView();
        }

        // Close the add/edit modal and reset fields.
        function closeAddModal() {
            setModalState('addModal', false);
            resetForm();
        }

        // Toggle repeat options based on repeat choice.
        function updateRepeatVisibility() {
            const repeats = document.getElementById('itemRepeats').value;
            const isRecurring = repeats !== 'none';
            document.getElementById('recurringGroup').style.display = repeats === 'weekly' ? 'block' : 'none';
            document.getElementById('repeatIntervalGroup').style.display = repeats === 'custom' ? 'block' : 'none';
            document.getElementById('dateGroup').style.display = 'block';
            document.getElementById('dateLabel').textContent = isRecurring ? 'Start date' : 'Date';
        }

        // Update form field visibility based on category.
        function updateFormFields() {
            const category = document.getElementById('itemCategory').value;
            document.getElementById('itemKind').setAttribute('list', category === 'event' ? 'eventTypes' : category === 'task' ? 'taskTypes' : 'blockTypes');

            document.getElementById('statusGroup').style.display = category === 'task' ? 'block' : 'none';
            document.getElementById('timeGroup').style.display = category === 'task' || category === 'event' || category === 'block' ? 'block' : 'none';
            document.getElementById('endTimeGroup').style.display = category === 'task' || category === 'event' || category === 'block' ? 'block' : 'none';
            document.getElementById('repeatToggleGroup').style.display = category === 'event' || category === 'block' ? 'block' : 'none';
            document.getElementById('durationGroup').style.display = category === 'task' ? 'block' : 'none';
            document.getElementById('locationGroup').style.display = category === 'event' || category === 'task' ? 'block' : 'none';
            document.getElementById('recurringGroup').style.display = 'none';
            document.getElementById('dateGroup').style.display = 'block';
            document.getElementById('repeatIntervalGroup').style.display = 'none';

            updateRepeatVisibility();
            updateStatusFields();
        }

        function updateStatusFields() {
            const category = document.getElementById('itemCategory').value;
            const status = document.getElementById('itemStatus').value;
            if (category === 'task' && status === 'inbox') {
                document.getElementById('timeGroup').style.display = 'none';
                document.getElementById('endTimeGroup').style.display = 'none';
            } else if (category === 'task') {
                document.getElementById('timeGroup').style.display = 'block';
                document.getElementById('endTimeGroup').style.display = 'block';
            }
        }

        // Populate the color picker UI.
        function initializeColorPicker() {
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = '';
            colors.forEach((color, index) => {
                const option = document.createElement('div');
                option.className = 'color-option';
                option.style.backgroundColor = color;
                option.onclick = () => selectColor(index);
                picker.appendChild(option);
            });
        }

        // Select a color for the current item.
        function selectColor(index) {
            document.querySelectorAll('.color-option').forEach((opt, i) => {
                opt.classList.toggle('selected', i === index);
            });
        }

        // Keep modal state and body scroll in sync.
        function setModalState(modalId, isOpen) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.toggle('active', isOpen);
            const anyOpen = ['addModal', 'settingsModal', 'reviewModal', 'lockModal'].some(id => {
                const el = document.getElementById(id);
                return el && el.classList.contains('active');
            });
            document.body.classList.toggle('modal-open', anyOpen);
        }

        // Close modals when clicking the backdrop.
        function setupModalDismissal() {
            const addModal = document.getElementById('addModal');
            const settingsModal = document.getElementById('settingsModal');
            const reviewModal = document.getElementById('reviewModal');
            if (addModal) {
                addModal.addEventListener('click', (event) => {
                    if (event.target === addModal) closeAddModal();
                });
            }
            if (settingsModal) {
                settingsModal.addEventListener('click', (event) => {
                    if (event.target === settingsModal) closeSettingsModal();
                });
            }
            if (reviewModal) {
                reviewModal.addEventListener('click', (event) => {
                    if (event.target === reviewModal) closeReviewModal();
                });
            }
        }

        // Keyboard shortcuts for closing modals.
        function setupGlobalShortcuts() {
            document.addEventListener('keydown', (event) => {
                if (event.key !== 'Escape') return;
                const addModal = document.getElementById('addModal');
                const settingsModal = document.getElementById('settingsModal');
                const reviewModal = document.getElementById('reviewModal');
                if (addModal && addModal.classList.contains('active')) {
                    closeAddModal();
                } else if (settingsModal && settingsModal.classList.contains('active')) {
                    closeSettingsModal();
                } else if (reviewModal && reviewModal.classList.contains('active')) {
                    closeReviewModal();
                }
            });
            document.addEventListener('keydown', (event) => {
                if (event.key !== 'Enter') return;
                const lockModal = document.getElementById('lockModal');
                if (lockModal && lockModal.classList.contains('active')) return;
                const quickInput = document.getElementById('quickCaptureInput');
                if (quickInput && document.activeElement === quickInput) {
                    event.preventDefault();
                    handleQuickCapture();
                    return;
                }
                const addModal = document.getElementById('addModal');
                if (!addModal || !addModal.classList.contains('active')) return;
                if (event.shiftKey) return;
                const tag = event.target ? event.target.tagName : '';
                if (tag === 'TEXTAREA' || tag === 'SELECT') return;
                event.preventDefault();
                addOrUpdateItem();
            });
            document.addEventListener('keydown', (event) => {
                if (event.key !== '/') return;
                const tag = event.target ? event.target.tagName : '';
                if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
                const searchInput = document.getElementById('searchInput');
                if (!searchInput) return;
                event.preventDefault();
                searchInput.focus();
            });
        }

        // Add/remove header shadow based on scroll position.
        function setupScrollShadows() {
            const header = document.querySelector('.header');
            const dateNav = document.querySelector('.date-nav');
            if (scrollShadowTarget && scrollShadowHandler) {
                scrollShadowTarget.removeEventListener('scroll', scrollShadowHandler);
            }
            scrollShadowTarget = document.querySelector('.time-scroll');
            if (!scrollShadowTarget || !header || !dateNav) return;
            scrollShadowHandler = () => {
                const isScrolled = scrollShadowTarget.scrollTop > 4;
                header.classList.toggle('scrolled', isScrolled);
                dateNav.classList.toggle('scrolled', isScrolled);
            };
            scrollShadowHandler();
            scrollShadowTarget.addEventListener('scroll', scrollShadowHandler, { passive: true });
        }

        // Swipe left/right on the day view to change dates.
        function setupDaySwipe() {
            if (daySwipeTarget && daySwipeHandlers) {
                daySwipeTarget.removeEventListener('pointerdown', daySwipeHandlers.onDown);
                daySwipeTarget.removeEventListener('pointermove', daySwipeHandlers.onMove);
                daySwipeTarget.removeEventListener('pointerup', daySwipeHandlers.onUp);
                daySwipeTarget.removeEventListener('pointercancel', daySwipeHandlers.onCancel);
            }
            daySwipeTarget = null;
            daySwipeHandlers = null;

            if (currentView !== 'day') return;
            const target = document.querySelector('.daily-view');
            if (!target) return;

            const state = { active: false, startX: 0, startY: 0 };
            const swipeThreshold = 36;
            const angleBias = 1.15;
            const ignoreSelector = 'input, select, textarea, button, .swipe-card, .day-tasks-panel, .inbox-panel, .time-block';

            const onDown = (event) => {
                if (event.pointerType === 'mouse' && event.button !== 0) return;
                if (event.target && event.target.closest(ignoreSelector)) return;
                state.active = true;
                state.startX = event.clientX;
                state.startY = event.clientY;
            };

            const onMove = (event) => {
                if (!state.active) return;
                const dx = event.clientX - state.startX;
                const dy = event.clientY - state.startY;
                if (Math.abs(dy) > Math.abs(dx) * angleBias) {
                    state.active = false;
                }
            };

            const onUp = (event) => {
                if (!state.active) return;
                const dx = event.clientX - state.startX;
                const dy = event.clientY - state.startY;
                state.active = false;
                if (Math.abs(dx) > swipeThreshold && Math.abs(dx) > Math.abs(dy) * angleBias) {
                    changeDate(dx < 0 ? 1 : -1);
                }
            };

            const onCancel = () => {
                state.active = false;
            };

            target.addEventListener('pointerdown', onDown);
            target.addEventListener('pointermove', onMove);
            target.addEventListener('pointerup', onUp);
            target.addEventListener('pointercancel', onCancel);

            daySwipeTarget = target;
            daySwipeHandlers = { onDown, onMove, onUp, onCancel };
        }

        // Swipe left/right on week/month views to change date range.
        function setupRangeSwipe() {
            const targets = [document.querySelector('.week-view'), document.querySelector('.month-view')];
            targets.forEach(target => {
                if (!target) return;
                let startX = 0;
                let startY = 0;
                let active = false;
                const threshold = 42;
                const angleBias = 1.15;

                const onDown = (event) => {
                    if (event.pointerType === 'mouse' && event.button !== 0) return;
                    if (event.target && event.target.closest('input, select, textarea, button, .swipe-card')) return;
                    active = true;
                    startX = event.clientX;
                    startY = event.clientY;
                };

                const onUp = (event) => {
                    if (!active) return;
                    const dx = event.clientX - startX;
                    const dy = event.clientY - startY;
                    active = false;
                    if (Math.abs(dx) > threshold && Math.abs(dx) > Math.abs(dy) * angleBias) {
                        const delta = dx < 0 ? 1 : -1;
                        if (target.classList.contains('week-view')) {
                            changeDate(delta * 7);
                        } else {
                            const next = new Date(currentDate);
                            next.setMonth(currentDate.getMonth() + delta);
                            currentDate = next;
                            updateCurrentDate();
                            renderView();
                        }
                    }
                };

                const onCancel = () => {
                    active = false;
                };

                target.addEventListener('pointerdown', onDown);
                target.addEventListener('pointerup', onUp);
                target.addEventListener('pointercancel', onCancel);
            });
        }

        // Refresh suggestion lists for item types.
        function refreshTypeSuggestions() {
            const eventSet = new Set(defaultEventTypes);
            const taskSet = new Set(defaultTaskTypes);
            const blockSet = new Set(defaultBlockTypes);

            items.forEach(item => {
                if (item.type === 'event' && item.label) eventSet.add(item.label);
                if (item.type === 'task' && item.label) taskSet.add(item.label);
                if (item.type === 'block' && item.label) blockSet.add(item.label);
            });

            const eventList = document.getElementById('eventTypes');
            const taskList = document.getElementById('taskTypes');
            eventList.innerHTML = '';
            taskList.innerHTML = '';
            const blockList = document.getElementById('blockTypes');
            if (blockList) blockList.innerHTML = '';

            Array.from(eventSet).sort().forEach(type => {
                const opt = document.createElement('option');
                opt.value = type;
                eventList.appendChild(opt);
            });

            Array.from(taskSet).sort().forEach(type => {
                const opt = document.createElement('option');
                opt.value = type;
                taskList.appendChild(opt);
            });

            if (blockList) {
                Array.from(blockSet).sort().forEach(type => {
                    const opt = document.createElement('option');
                    opt.value = type;
                    blockList.appendChild(opt);
                });
            }
        }

        // Initialize all time picker dropdowns.
        function initializeTimePickers() {
            document.querySelectorAll('.time-picker').forEach(picker => {
                const hour = picker.querySelector('.time-hour');
                const minute = picker.querySelector('.time-minute');
                const ampm = picker.querySelector('.time-ampm');
                hour.innerHTML = '<option value=""></option>';
                minute.innerHTML = '<option value=""></option>';
                ampm.innerHTML = '<option value=""></option>';

                for (let h = 1; h <= 12; h++) {
                    const opt = document.createElement('option');
                    opt.value = String(h);
                    opt.textContent = String(h);
                    hour.appendChild(opt);
                }

                for (let m = 0; m < 60; m++) {
                    const opt = document.createElement('option');
                    opt.value = String(m).padStart(2, '0');
                    opt.textContent = String(m).padStart(2, '0');
                    minute.appendChild(opt);
                }

                ['AM', 'PM'].forEach(period => {
                    const opt = document.createElement('option');
                    opt.value = period;
                    opt.textContent = period;
                    ampm.appendChild(opt);
                });

                [hour, minute, ampm].forEach(select => {
                    select.addEventListener('change', () => {});
                });
            });
        }

        // Clear a time picker selection.
        function clearTimePicker(fieldId) {
            const picker = document.querySelector(`[data-field="${fieldId}"]`);
            if (!picker) return;
            picker.querySelector('.time-hour').value = '';
            picker.querySelector('.time-minute').value = '';
            picker.querySelector('.time-ampm').value = '';
        }

        // Apply quick recurring presets.
        function applyRecurringPreset(preset) {
            const map = {
                weekdays: [1, 2, 3, 4, 5],
                weekends: [0, 6],
                daily: [0, 1, 2, 3, 4, 5, 6]
            };
            const values = map[preset] || [];
            document.querySelectorAll('.day-checkbox').forEach(cb => {
                cb.checked = values.includes(parseInt(cb.value, 10));
            });
        }

        function clearRecurringPreset() {
            document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
        }

        function shiftTime(time, minutesDelta) {
            if (!time) return '';
            const [hours, minutes] = time.split(':').map(Number);
            if (Number.isNaN(hours) || Number.isNaN(minutes)) return '';
            const total = hours * 60 + minutes + minutesDelta;
            const clamped = Math.max(0, Math.min(total, 23 * 60 + 59));
            const h = Math.floor(clamped / 60);
            const m = clamped % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // Read a time picker value in 24h format.
        function getTimePickerValue(fieldId) {
            const picker = document.querySelector(`[data-field="${fieldId}"]`);
            if (!picker) return '';
            const hour = picker.querySelector('.time-hour').value;
            const minute = picker.querySelector('.time-minute').value;
            const ampm = picker.querySelector('.time-ampm').value;
            if (!hour || !minute || !ampm) return '';
            let h = parseInt(hour, 10);
            if (ampm === 'PM' && h !== 12) h += 12;
            if (ampm === 'AM' && h === 12) h = 0;
            return `${String(h).padStart(2, '0')}:${minute}`;
        }

        // Populate a time picker using a 24h value.
        function setTimePickerValue(fieldId, value) {
            const picker = document.querySelector(`[data-field="${fieldId}"]`);
            if (!picker) return;
            if (!value) {
                clearTimePicker(fieldId);
                return;
            }
            const [hours, minutes] = value.split(':');
            let h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            picker.querySelector('.time-hour').value = String(h);
            picker.querySelector('.time-minute').value = minutes;
            picker.querySelector('.time-ampm').value = ampm;
        }

        // Add or update an item in the appropriate list.
        function addOrUpdateItem() {
            const category = document.getElementById('itemCategory').value;
            const label = document.getElementById('itemKind').value.trim();
            const fallbackLabel = category === 'event' ? 'Event' : category === 'block' ? 'Focus Block' : 'Task';
            const title = document.getElementById('itemTitle').value.trim();

            if (!title) {
                alert('Please enter a title');
                return;
            }

            const id = editingItem ? editingItem.id : Date.now().toString();
            const repeatValue = document.getElementById('itemRepeats').value;
            const repeats = repeatValue !== 'none';

            const recurringDays = [];
            document.querySelectorAll('.day-checkbox:checked').forEach(cb => {
                recurringDays.push(parseInt(cb.value, 10));
            });

            const selectedColor = document.querySelector('.color-option.selected');
            const colorIndex = Array.from(document.querySelectorAll('.color-option')).indexOf(selectedColor);
            const color = colors[colorIndex >= 0 ? colorIndex : 0];
            const priority = document.getElementById('itemPriority').value || 'should';
            const tag = document.getElementById('itemTag').value.trim();
            const durationValue = parseInt(document.getElementById('itemDuration').value, 10);
            let duration = Number.isFinite(durationValue) && durationValue > 0 ? durationValue : 30;
            let location = document.getElementById('itemLocation').value.trim();
            const status = category === 'task' ? document.getElementById('itemStatus').value : 'scheduled';
            const checklist = document.getElementById('itemChecklist').value
                .split('\n')
                .map(line => line.replace(/^-/, '').trim())
                .filter(Boolean);
            const links = document.getElementById('itemLinks').value
                .split(',')
                .map(link => link.trim())
                .filter(Boolean);

            const startTime = getTimePickerValue('itemStartTime');
            const endTime = getTimePickerValue('itemEndTime');
            const startDate = document.getElementById('itemDate').value;
            const intervalValue = parseInt(document.getElementById('repeatInterval').value, 10) || 1;
            const repeatUnit = document.getElementById('repeatUnit').value;
            const recurrence = repeats ? {
                freq: repeatValue === 'custom' ? repeatUnit : repeatValue,
                interval: repeatValue === 'custom' ? intervalValue : 1,
                unit: repeatValue === 'custom' ? repeatUnit : repeatValue,
                days: repeatValue === 'weekly' ? recurringDays : []
            } : { freq: 'none', interval: 1, days: [] };

            if (startTime && endTime) {
                const computed = getDurationFromTimes(startTime, endTime);
                if (computed) duration = computed;
            }

            let finalStatus = status;
            if (category === 'task' && status === 'scheduled' && !startTime) {
                finalStatus = 'inbox';
            }
            if (category !== 'task' && !startTime) {
                alert('Please set a start time for events and focus blocks.');
                return;
            }

            const computedEndTime = startTime ? minutesToTime(timeToMinutes(startTime) + duration) : '';
            const common = {
                id,
                type: category,
                label: label || fallbackLabel,
                title,
                color,
                description: document.getElementById('itemDescription').value.trim(),
                priority,
                tag,
                duration,
                location,
                checklist,
                links,
                status: finalStatus,
                date: finalStatus === 'scheduled' ? startDate : '',
                startTime: finalStatus === 'scheduled' ? startTime : '',
                endTime: finalStatus === 'scheduled' ? (endTime || computedEndTime) : '',
                recurrence
            };

            const existing = items.find(entry => entry.id === id);
            if (editingItem && existing && existing.recurrence && existing.recurrence.freq !== 'none') {
                const applySeries = document.getElementById('applySeriesToggle').checked;
                if (!applySeries && editingItem.dateStr) {
                    existing.overrides = existing.overrides || {};
                    existing.overrides[editingItem.dateStr] = {
                        ...common,
                        date: editingItem.dateStr,
                        status: finalStatus,
                        startTime: startTime,
                        endTime: endTime
                    };
                } else {
                    Object.assign(existing, common);
                }
            } else if (existing) {
                Object.assign(existing, common);
            } else {
                items.push({ ...common, exceptions: [], overrides: {} });
            }

            saveData();
            refreshTypeSuggestions();
            closeAddModal();
            renderView();
            scheduleReminders();
        }

        // Add a new item or update an existing one.
        function upsertItem(list, item, id) {
            const index = list.findIndex(i => i.id === id);
            if (index >= 0) {
                list[index] = { ...list[index], ...item };
            } else {
                list.push(item);
            }
        }

        // Delete the currently edited item.
        function deleteCurrentItem() {
            if (!editingItem) return;
            deleteItem(editingItem.id);
            closeAddModal();
        }

        // Delete an item from its list.
        function deleteItem(id) {
            items = items.filter(entry => entry.id !== id);
            saveData();
            refreshTypeSuggestions();
            renderView();
            scheduleReminders();
        }

        // Reset modal inputs.
        function resetForm() {
            document.getElementById('itemTitle').value = '';
            document.getElementById('itemKind').value = '';
            document.getElementById('itemDescription').value = '';
            document.getElementById('itemRepeats').value = 'none';
            document.getElementById('repeatInterval').value = '1';
            document.getElementById('repeatUnit').value = 'day';
            document.getElementById('itemPriority').value = 'should';
            document.getElementById('itemTag').value = '';
            document.getElementById('itemDuration').value = '';
            document.getElementById('itemLocation').value = '';
            document.getElementById('itemStatus').value = 'inbox';
            document.getElementById('itemChecklist').value = '';
            document.getElementById('itemLinks').value = '';
            document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            clearTimePicker('itemStartTime');
            clearTimePicker('itemEndTime');
        }

        // Format a Date object as YYYY-MM-DD.
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Format a 24h time to 12h display.
        function formatTime(time) {
            if (!time) return '';
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${ampm}`;
        }

        function timeToMinutes(time) {
            if (!time) return 0;
            const [hours, minutes] = time.split(':').map(Number);
            return (hours || 0) * 60 + (minutes || 0);
        }

        function minutesToTime(minutes) {
            const clamped = Math.max(0, Math.min(minutes, 24 * 60 - 1));
            const hours = Math.floor(clamped / 60);
            const mins = clamped % 60;
            return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        }

        function getDurationFromTimes(start, end) {
            if (!start || !end) return 0;
            const startMinutes = timeToMinutes(start);
            const endMinutes = timeToMinutes(end);
            return Math.max(endMinutes - startMinutes, 0);
        }

        function formatDuration(minutes) {
            if (!minutes) return '';
            const mins = parseInt(minutes, 10);
            if (!Number.isFinite(mins) || mins <= 0) return '';
            const hours = Math.floor(mins / 60);
            const remaining = mins % 60;
            if (hours && remaining) return `${hours}h ${remaining}m`;
            if (hours) return `${hours}h`;
            return `${remaining}m`;
        }

        function getPriorityLabel(priority) {
            if (priority === 'must') return 'Must';
            if (priority === 'should') return 'Should';
            if (priority === 'optional') return 'Optional';
            return 'Should';
        }

        function getPriorityClass(priority) {
            if (priority === 'must') return 'priority-high';
            if (priority === 'should') return 'priority-medium';
            if (priority === 'optional') return 'priority-low';
            return 'priority-medium';
        }

        function getPriorityRank(priority) {
            const order = { must: 0, should: 1, optional: 2 };
            return order[priority] ?? 1;
        }

        // Format a slot label like 1 PM.
        function formatHourLabel(hour) {
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const h12 = hour % 12 || 12;
            return `${h12} ${ampm}`;
        }

        // Extract hour from a 24h time string.
        function getHourFromTime(time) {
            if (!time) return -1;
            const [hours] = time.split(':');
            return parseInt(hours, 10);
        }

        function getMinuteFromTime(time) {
            if (!time) return 0;
            const [, minutes] = time.split(':');
            return parseInt(minutes, 10) || 0;
        }

        function getItemSortValue(item) {
            const time = item.startTime || '';
            if (!time) return 24 * 60 + 1;
            const [hours, minutes] = time.split(':').map(Number);
            return (hours || 0) * 60 + (minutes || 0);
        }

        function getNextItemForDay(items, dateStr) {
            if (!items.length) return null;
            const sorted = [...items].sort((a, b) => getItemSortValue(a) - getItemSortValue(b));
            const isTodayView = isToday(new Date(dateStr));
            if (!isTodayView) return sorted[0];
            const now = new Date();
            const nowValue = now.getHours() * 60 + now.getMinutes();
            return sorted.find(item => getItemSortValue(item) >= nowValue) || sorted[0];
        }

        // Update the reminder toggle button state.
        function updateNotificationButton() {
            const btn = document.getElementById('notifyButton');
            if (!btn) return;
            btn.textContent = notificationsEnabled ? 'Notifications On' : 'Notifications Off';
            btn.classList.toggle('active', notificationsEnabled);
        }

        // Ask for notification permission or toggle it.
        function toggleNotifications() {
            if (!('Notification' in window)) {
                alert('Notifications are not supported in this browser.');
                return;
            }

            if (Notification.permission === 'granted') {
                notificationsEnabled = !notificationsEnabled;
                localStorage.setItem('plannerNotifications', notificationsEnabled ? 'on' : 'off');
                updateNotificationButton();
                scheduleReminders();
                return;
            }

            if (Notification.permission === 'denied') {
                alert('Notifications are blocked in your browser settings.');
                return;
            }

            Notification.requestPermission().then(permission => {
                notificationsEnabled = permission === 'granted';
                localStorage.setItem('plannerNotifications', notificationsEnabled ? 'on' : 'off');
                updateNotificationButton();
                scheduleReminders();
            });
        }

        // Clear any scheduled reminder timers.
        function clearReminderTimers() {
            reminderTimers.forEach(timer => clearTimeout(timer));
            reminderTimers = [];
        }

        // Schedule upcoming reminders while the app is open.
        function scheduleReminders() {
            clearReminderTimers();
            if (!notificationsEnabled || !('Notification' in window) || Notification.permission !== 'granted') return;

            const now = new Date();
            const maxWindowMs = 2 * 24 * 60 * 60 * 1000;

            const schedule = (title, body, when) => {
                const delta = when - now;
                if (delta <= 0 || delta > maxWindowMs) return;
                const timer = setTimeout(() => {
                    new Notification(title, { body });
                }, delta);
                reminderTimers.push(timer);
            };

            items.forEach(item => {
                if (item.status !== 'scheduled' || !item.startTime) return;
                const dateStr = item.date || formatDate(currentDate);
                const start = new Date(`${dateStr}T${item.startTime}`);
                const notifyAt = new Date(start.getTime() - 10 * 60 * 1000);
                schedule(`${item.title} starting soon`, item.description || item.label || 'Upcoming', notifyAt);
            });
        }

    </script>
</body>
</html>
